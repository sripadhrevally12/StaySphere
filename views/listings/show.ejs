<% layout("/layouts/boilerplate") %>

<style>
/* ================= CATEGORY BADGE ================= */
.category-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  background: #f1f1f1;
  color: #444;
  font-size: 0.8rem;
  padding: 0.4rem 0.7rem;
  border-radius: 999px;
  margin-top: 0.4rem;
}

/* ================= REVIEW ================= */
.review-form {
  background: #fff;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.review-card {
  border-radius: 1rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  border: none;
}

/* ================= MOBILE ONLY ================= */
@media (max-width: 768px) {

  .review-card {
    width: 100%;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  .review-card.col-5 {
    flex: 0 0 100%;
    max-width: 100%;
  }

  .review-card p {
    font-size: 0.95rem;
  }

  .review-form {
    padding: 1.2rem;
  }
}
</style>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const listing = <%- JSON.stringify(listing) %>;
</script>

<div class="row mt-3">

  <!-- TITLE + CATEGORY -->
  <div class="col-8 offset-2">
    <h3 class="listing-title-main"><%= listing.title %></h3>

    <span class="category-badge">
      <i class="fa-solid fa-tag"></i>
      <%= listing.category.charAt(0).toUpperCase() + listing.category.slice(1) %>
    </span>
  </div>

  <!-- IMAGE + DETAILS -->
  <div class="card col-8 offset-2 mt-3">
    <img
      src="<%= listing.image?.url || listing.image %>"
      class="card-img-top"
      style="height: 26rem; object-fit: cover;"
      alt="listing image"
    >

    <div class="card-body">
      <p class="text-muted mb-1">
        Owned by <%= listing.owner.username %>
      </p>

      <p><%= listing.description %></p>

      <p class="fw-semibold">
        â‚¹ <%= listing.price.toLocaleString("en-IN") %> / night
      </p>

      <p class="text-muted">
        <%= listing.location %>, <%= listing.country %>
      </p>
    </div>
  </div>

  <!-- EDIT / DELETE (OWNER ONLY) -->
  <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
    <div class="col-8 offset-2 mt-3 d-flex gap-3">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>
      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
        <button class="btn btn-dark">Delete</button>
      </form>
    </div>
  <% } %>

  <!-- REVIEW FORM -->
  <% if (currUser) { %>
  <div class="col-8 offset-2 mt-4">
    <hr>
    <h4>Leave a Review</h4>

    <form
      action="/listings/<%= listing._id %>/reviews"
      method="POST"
      class="needs-validation review-form"
      novalidate
    >
      <fieldset class="starability-slot mb-3">
        <input type="radio" class="input-no-rate" name="review[rating]" value="0" checked />
        <input type="radio" id="r1" name="review[rating]" value="1"><label for="r1">1</label>
        <input type="radio" id="r2" name="review[rating]" value="2"><label for="r2">2</label>
        <input type="radio" id="r3" name="review[rating]" value="3"><label for="r3">3</label>
        <input type="radio" id="r4" name="review[rating]" value="4"><label for="r4">4</label>
        <input type="radio" id="r5" name="review[rating]" value="5"><label for="r5">5</label>
      </fieldset>

      <textarea
        name="review[comment]"
        class="form-control mb-3"
        rows="4"
        required
      ></textarea>

      <button class="btn btn-outline-dark">Submit</button>
    </form>
  </div>
  <% } %>

  <!-- REVIEWS -->
  <% if (listing.reviews.length > 0) { %>
  <div class="col-8 offset-2 mt-4">
    <h5>All Reviews</h5>

    <div class="row">
      <% for (let review of listing.reviews) { %>
        <div class="card col-5 me-3 mb-3 review-card">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-start">
              <strong>@<%= review.author.username %></strong>

              <% if (currUser && review.author._id.equals(currUser._id)) { %>
                <form
                  method="POST"
                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                >
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              <% } %>
            </div>

            <p class="starability-result mt-1" data-rating="<%= review.rating %>"></p>
            <p class="mb-0"><%= review.comment %></p>

          </div>
        </div>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- MAP -->
  <div class="col-8 offset-2 mt-4">
    <h4>Where you'll be</h4>
    <div id="map"></div>
  </div>

</div>

<script src="/js/map.js"></script>
